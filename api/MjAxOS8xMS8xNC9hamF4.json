{"title":"JavaScript —— Ajax","date":"2019-11-14T01:04:23.101Z","thumbnail":"https://s2.ax1x.com/2019/11/14/MYfB9I.md.jpg","link":"2019/11/14/ajax","updated":"2019-11-25T07:49:28.892Z","content":"<p>Ajax，<strong>A</strong>synchronous <strong>J</strong>avascript <strong>A</strong>nd <strong>X</strong>ML，异步的JavaScript 和 XML。</p>\n<h2 id=\"XMLHttpRequest\">XMLHttpRequest<a href=\"2019/11/14/ajax#XMLHttpRequest\"></a></h2><figure class=\"highlight javascript\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// get请求</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> xhr = <span class=\"keyword\">new</span> XMLHttpRequest()</span><br><span class=\"line\">xhr.open(<span class=\"string\">'GET'</span>, <span class=\"string\">'./data/test.json'</span>, <span class=\"literal\">true</span>)</span><br><span class=\"line\">xhr.onreadystatechange = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (xhr.readyState === <span class=\"number\">4</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (xhr.status === <span class=\"number\">200</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">xhr.send(<span class=\"literal\">null</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// post请求</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> xhr = <span class=\"keyword\">new</span> XMLHttpRequest()</span><br><span class=\"line\">xhr.open(<span class=\"string\">'POST'</span>, <span class=\"string\">'/login'</span>, <span class=\"literal\">true</span>)</span><br><span class=\"line\">xhr.onreadystatechange = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (xhr.readyState === <span class=\"number\">4</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (xhr.status === <span class=\"number\">200</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">const</span> postData = &#123;</span><br><span class=\"line\">  name: <span class=\"string\">'zhangsan'</span>,</span><br><span class=\"line\">  password: <span class=\"string\">'123'</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">xhr.send(<span class=\"built_in\">JSON</span>.stringify(postData))</span><br></pre></td></tr></table></div></figure>\n\n<p><strong>xhr.readyState</strong></p>\n<ul>\n<li>0 - (未初始化)，还没有调用send()</li>\n<li>1 - (载入)，已调用send()，正在发送请求</li>\n<li>2 - (载入完成)，send()方法执行完成，已接收到全部的响应内容</li>\n<li>3 - (交互)，正在解析响应内容</li>\n<li>4 - (完成)，响应内容解析完成，可以在客户端调用</li>\n</ul>\n<p><strong>xhr.status</strong></p>\n<ul>\n<li>1xx - 指示信息，表示资源已经请求，继续处理</li>\n<li>2xx - 表示成功处理请求，如200</li>\n<li>3xx - 需要重定向，浏览器直接跳转<ul>\n<li>301 - 永久重定向，每次访问A地址的时候，浏览器会自动跳到B地址</li>\n<li>302 - 临时重新向，仅一次访问A地址时调到B，下次访问还是跳到A</li>\n<li>304 - 资源未改变，若请求返回的资源与之前的相比没发生改变，服务器会返回304，浏览器会使用自己先前缓存的资源</li>\n</ul>\n</li>\n<li>4xx - 客户端请求错误<ul>\n<li>400 - 客户端请求有语法错误，不能被服务器端所理解</li>\n<li>401 - 请求未经过授权，这个状态码必须和WWW-Authenticate报头域一起使用</li>\n<li>403 - 服务器收到请求，但是拒绝提供该服务</li>\n<li>404 - 请求的地址错误</li>\n</ul>\n</li>\n<li>5xx - 服务端错误<ul>\n<li>500 - 服务器发生不可预期的错误</li>\n<li>503 - 服务器当前不能处理客户端的请求，一段时间后可能恢复正常</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"同源策略\">同源策略<a href=\"2019/11/14/ajax#同源策略\"></a></h2><ul>\n<li>同源策略：ajax请求时，浏览器要求当前网页和server必须同源（安全）</li>\n<li>同源：协议，域名，端口必须都一致</li>\n<li>加载图片、CSS、JS可无视同源策略，所以：<ul>\n<li><code>&lt;img/&gt;</code>可以用于统计打点，使用第三方的统计服务</li>\n<li><code>&lt;link/&gt;</code>  <code>&lt;script&gt;</code>可以使用CDN</li>\n<li><code>&lt;script&gt;</code>实现 JSONP</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"跨域\">跨域<a href=\"2019/11/14/ajax#跨域\"></a></h2><p>所有的跨域，都必须经过server端的允许和配合</p>\n<ul>\n<li><p>JSONP</p>\n<p>原理：</p>\n<ul>\n<li><code>&lt;script&gt;</code>可以绕开跨域限制</li>\n<li>服务器可以任意动态拼接数据返回</li>\n</ul>\n<p>例子：</p>\n<figure class=\"highlight html\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- jsonp.html --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"built_in\">window</span>.callback = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">data</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.log(data)</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">src</span>=<span class=\"string\">\"http://localhost:8002/jsonp.js\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></div></figure>\n\n<figure class=\"highlight javascript\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// jsonp.js</span></span><br><span class=\"line\">callback(&#123;</span><br><span class=\"line\">  name: <span class=\"string\">'zhangsan'</span></span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></div></figure>\n\n\n\n</li>\n</ul>\n<ul>\n<li><p>CORS</p>\n<p>服务器端设置http-header</p>\n<figure class=\"highlight java\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">response.setHeader(<span class=\"string\">\"Access-Control-Allow-Origin\"</span>, <span class=\"string\">\"http://localhost:8011\"</span>)</span><br><span class=\"line\">response.setHeader(<span class=\"string\">\"Access-Control-Allow-Headers\"</span>, <span class=\"string\">\"X-Requested-With\"</span>)  </span><br><span class=\"line\">response.setHeader(<span class=\"string\">\"Access-Control-Allow-Methods\"</span>, <span class=\"string\">\"PUT,POST,GET,DELETE,OPTIONS\"</span>) </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 接收跨域的Cookies</span></span><br><span class=\"line\">response.setHeader(<span class=\"string\">\"Access-Control-Allow-Credentials\"</span>, <span class=\"string\">\"true\"</span>)</span><br></pre></td></tr></table></div></figure>\n\n\n\n</li>\n</ul>\n<h2 id=\"手写简易Ajax\">手写简易Ajax<a href=\"2019/11/14/ajax#手写简易Ajax\"></a></h2><figure class=\"highlight javascript\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">ajax</span>(<span class=\"params\">url</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>( <span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> xhr = <span class=\"keyword\">new</span> XMLHttpRequest()</span><br><span class=\"line\">    xhr.open(<span class=\"string\">'GET'</span>, url, <span class=\"literal\">true</span>)</span><br><span class=\"line\">    xhr.onreadystatechange = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (xhr.readyState === <span class=\"number\">4</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (xhr.status === <span class=\"number\">200</span>) &#123;</span><br><span class=\"line\">          resolve(<span class=\"built_in\">JSON</span>.parse(xhr.responseText))</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (xhr.status === <span class=\"number\">404</span>)&#123;</span><br><span class=\"line\">          reject(<span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(<span class=\"string\">'404 Not Found'</span>))</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    xhr.send(<span class=\"literal\">null</span>)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>","prev":{"title":"JavaScript —— 存储","link":"2019/11/14/storage"},"next":{"title":"JavaScript —— 事件","link":"2019/11/13/event"},"plink":"http://allenxz.github.io/2019/11/14/ajax/","toc":[{"title":"XMLHttpRequest","id":"XMLHttpRequest","index":"1"},{"title":"同源策略","id":"同源策略","index":"2"},{"title":"跨域","id":"跨域","index":"3"},{"title":"手写简易Ajax","id":"手写简易Ajax","index":"4"}]}